# Cursor Rules for TypeScript Development

## Type Safety Rules

### ANY Type Usage
- **STRICTLY AVOID** using `any` type unless absolutely necessary
- Only use `any` type in the following specific cases:
  1. **Prisma JSON/JSONB fields**: When working with Prisma's JSON/JSONB types (metadata, responseFormat, etc.)
  2. **Third-party library types**: When dealing with libraries that don't have proper TypeScript types
  3. **Legacy code migration**: Temporarily during refactoring legacy code

### When Using ANY Type
- **ALWAYS** add a comment explaining why `any` is necessary
- **ALWAYS** use `// eslint-disable-next-line @typescript-eslint/no-explicit-any` before the line
- **ALWAYS** add a descriptive comment about the context (e.g., "Prisma JSON type - stored as JSONB")
- Example:
  ```typescript
  // Prisma JSON type - metadata stored as JSONB
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  metadata: metadata as any,
  ```

### Type Definitions
- **ALWAYS** define proper TypeScript interfaces/types for all data structures
- **ALWAYS** use type inference where possible instead of explicit `any`
- **PREFER** `unknown` over `any` when the type is truly unknown (e.g., in error handling)
- **PREFER** union types over `any` when multiple types are possible

### Error Handling
- Use `error: unknown` instead of `error: any` in catch blocks
- Use type guards to narrow down the type:
  ```typescript
  catch (error: unknown) {
    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
    // ...
  }
  ```

### Prisma-Specific Rules
- When working with Prisma JSON fields, use `as any` with proper comments
- When working with Prisma query results, prefer proper type inference or explicit types
- Example for Prisma JSON:
  ```typescript
  // Prisma JSON type - responseFormat stored as JSONB
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const responseFormat = config.responseFormat as { type: string } | undefined;
  ```

### Code Review Checklist
Before submitting code, ensure:
- [ ] No `any` types without proper comments and eslint-disable
- [ ] All `any` usages are justified and documented
- [ ] Type definitions exist for all data structures
- [ ] Error handling uses `unknown` instead of `any`
- [ ] Prisma JSON fields have proper type casting with comments

### Examples of BAD Practices (DO NOT DO)
```typescript
// ❌ BAD: Using any without comment or justification
const data: any = await fetchData();

// ❌ BAD: Using any in function parameters
function processData(data: any) { }

// ❌ BAD: Using any in catch blocks
catch (error: any) { }
```

### Examples of GOOD Practices (DO THIS)
```typescript
// ✅ GOOD: Proper type definition
interface UserData {
  id: number;
  name: string;
}
const data: UserData = await fetchData();

// ✅ GOOD: Using unknown in error handling
catch (error: unknown) {
  const errorMessage = error instanceof Error ? error.message : 'Unknown error';
}

// ✅ GOOD: Prisma JSON with proper comment and eslint-disable
// Prisma JSON type - metadata stored as JSONB
// eslint-disable-next-line @typescript-eslint/no-explicit-any
metadata: metadata as any,
```

## General TypeScript Best Practices
- Always use strict TypeScript mode
- Prefer type inference over explicit types when types are obvious
- Use type guards for runtime type checking
- Use discriminated unions for complex type scenarios
- Avoid type assertions unless absolutely necessary
- Use `as const` for literal types when needed

## Fixtures Data Requirements

### Exercise Requirements
- **MANDATORY**: Each chapter MUST have at least **15 exercises** (questions) across all difficulty levels (easy, medium, hard)
- **MANDATORY**: Each lesson MUST have at least **1 essay question** (type: "essay")
- Exercises can be distributed across multiple lessons within a chapter
- The total count of exercises per chapter should be verified before seeding

### Exercise Structure
- Each exercise must have:
  - `uuid`: String (REQUIRED) - Unique identifier to prevent database duplicates. Must be a valid UUID v4 format
  - `title`: String - descriptive title
  - `type`: "multiple_choice" | "essay"
  - `points`: Number - points for this question
  - `question`: String - the question text
  - `hint`: String (optional) - hint for the question
  - `created_at`: ISO 8601 date string

### Multiple Choice Exercises
- Must include:
  - `options`: Object with keys A, B, C, D (or more)
  - `correctOption`: String - the correct option key (e.g., "A", "B", "C", "D")

### Essay Exercises
- Must include:
  - `answer`: String - sample answer or answer template
  - `type`: "essay"
- Essay questions should test deeper understanding and application

### UUID Requirements
- **MANDATORY**: Every exercise MUST have a `uuid` field
- UUID format: Must be valid UUID v4 (e.g., "550e8400-e29b-41d4-a716-446655440000")
- Purpose: Prevent duplicate exercises in database when seeding
- Generation: Use `crypto.randomUUID()` or similar UUID generator
- Uniqueness: Each exercise must have a unique UUID across all fixtures

### Validation Checklist
Before creating or updating fixtures, ensure:
- [ ] Each chapter has at least 15 exercises total
- [ ] Each lesson has at least 1 essay question
- [ ] All exercises have required fields (uuid, title, type, points, question)
- [ ] All exercises have unique UUID values
- [ ] UUID format is valid (UUID v4)
- [ ] Multiple choice exercises have options and correctOption
- [ ] Essay exercises have answer field
- [ ] All timestamps are valid ISO 8601 format
- [ ] Exercise order is logical and sequential

### Examples

#### Good: Chapter with 15+ exercises
```json
{
  "chapters": [
    {
      "code": "CH1",
      "name": "Chương 1: Example",
      "lessons": [
        {
          "code": "SUBJECT-CH1-L1",
          "title": "Lesson 1",
          "exercises": [
            {
              "uuid": "550e8400-e29b-41d4-a716-446655440001",
              "title": "Multiple choice question",
              "type": "multiple_choice",
              "points": 1,
              "question": "What is...?",
              "options": { "A": "...", "B": "...", "C": "...", "D": "..." },
              "correctOption": "A",
              "hint": "Hint text",
              "created_at": "2025-01-01T00:00:00.000Z"
            },
            {
              "uuid": "550e8400-e29b-41d4-a716-446655440002",
              "title": "Essay question",
              "type": "essay",
              "points": 2,
              "question": "Explain...",
              "answer": "Sample answer",
              "hint": "Hint text",
              "created_at": "2025-01-01T00:00:01.000Z"
            }
          ]
        }
      ]
    }
  ]
}
```

#### Bad: Chapter with insufficient exercises
```json
{
  "chapters": [
    {
      "code": "CH1",
      "name": "Chương 1: Example",
      "lessons": [
        {
          "code": "SUBJECT-CH1-L1",
          "title": "Lesson 1",
          "exercises": [
            // ❌ BAD: Only 3 exercises, need at least 15 per chapter
            // ❌ BAD: No essay question in this lesson
            // ❌ BAD: Missing uuid field
            {
              "title": "Question 1",
              "type": "multiple_choice",
              // ... missing fields (uuid, options, correctOption, etc.)
            }
          ]
        }
      ]
    }
  ]
}
```

### Scripts for Validation
- Use `scripts/add-questions-to-informatics.ts` as reference for adding questions programmatically
- Always verify exercise count before seeding: `npx tsx scripts/seed-informatics.ts`

