<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Schema - H·ªá Th·ªëng D·∫°y H·ªçc</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 5px;
        }
        .legend {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        .legend h3 {
            margin-top: 0;
            color: #333;
        }
        .legend-item {
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 3px;
        }
        .legend-item strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è Database Schema Diagram</h1>
        <p class="subtitle">H·ªá Th·ªëng D·∫°y H·ªçc v√† Qu·∫£n L√Ω Vi·ªác H·ªçc</p>
        
        <div class="mermaid">
erDiagram
    %% Core Education Structure
    GRADES ||--o{ SUBJECTS : "has"
    GRADES ||--o{ CURRICULA : "has"
    SUBJECTS ||--o{ CHAPTERS : "contains"
    CHAPTERS ||--o{ SECTIONS : "contains"
    SECTIONS ||--o{ LESSONS : "has"
    SECTIONS ||--o{ EXERCISES : "has"
    
    %% Exercise Structure
    EXERCISES ||--o{ EXERCISE_QUESTIONS : "contains"
    
    %% User Management
    USERS ||--o{ USER_LEVELS : "has"
    USERS ||--o{ USER_LESSON_PROGRESS : "tracks"
    USERS ||--o{ USER_EXERCISE_ATTEMPTS : "attempts"
    USERS ||--o{ NOTIFICATIONS : "receives"
    USERS ||--o{ CONVERSATIONS : "has"
    GRADES ||--o{ USERS : "enrolled_in"
    
    %% Progress Tracking
    LESSONS ||--o{ USER_LESSON_PROGRESS : "tracked_by"
    EXERCISES ||--o{ USER_EXERCISE_ATTEMPTS : "attempted_by"
    
    %% Level Tracking
    SUBJECTS ||--o{ USER_LEVELS : "tracked_for"
    
    %% Conversation & Chat System
    CONVERSATION_CONFIGS ||--o{ CONVERSATIONS : "uses"
    CONVERSATIONS ||--o{ MESSAGES : "contains"
    
    %% Table Definitions
    GRADES {
        int id PK
        string name
        int level "1-12"
        datetime created_at
        datetime updated_at
    }
    
    CURRICULA {
        int id PK
        int grade_id FK
        string course_year "Kh√≥a h·ªçc, v√≠ d·ª•: 2025-2026"
        string subject "M√¥n h·ªçc, v√≠ d·ª•: To√°n, Ti·∫øng Anh"
        json lessons "Array of lessons (kh√¥ng ch·ª©a exercises)"
        datetime created_at
        datetime updated_at
    }
    
    SUBJECTS {
        int id PK
        string name
        int grade_id FK
        string description
        int order
        datetime created_at
        datetime updated_at
    }
    
    CHAPTERS {
        int id PK
        string name
        int subject_id FK
        string description
        int order
        datetime created_at
        datetime updated_at
    }
    
    SECTIONS {
        int id PK
        string name
        int chapter_id FK
        string description
        int order
        datetime created_at
        datetime updated_at
    }
    
    LESSONS {
        int id PK
        string title
        text content
        int section_id FK
        string type "video/pdf/text/slide"
        string media_url
        json attachments
        int order
        datetime created_at
        datetime updated_at
    }
    
    EXERCISES {
        int id PK
        string title
        text description
        int section_id FK
        string difficulty "easy/medium/hard"
        string type "multiple_choice/essay"
        int points
        int time_limit "minutes"
        int order
        datetime created_at
        datetime updated_at
    }
    
    EXERCISE_QUESTIONS {
        int id PK
        int exercise_id FK
        text question
        text answer
        json options "For multiple choice"
        text hint "Hint for the question"
        int order
        int points
        datetime created_at
        datetime updated_at
    }
    
    USERS {
        int id PK
        string username UK "Login credential"
        string password_hash
        string email "Nullable - optional"
        string name
        string display_name "Optional display name"
        string role "admin/student"
        string phone "Nullable - optional"
        string avatar_url
        boolean is_active
        int grade_id FK "Reference to Grade"
        int level "User level 1-12"
        datetime created_at
        datetime updated_at
    }
    
    USER_LEVELS {
        int id PK
        int user_id FK
        int subject_id FK
        decimal level_score "0-100"
        int total_exercises
        int correct_exercises
        decimal accuracy_rate
        datetime last_updated
        datetime created_at
    }
    
    USER_LESSON_PROGRESS {
        int id PK
        int user_id FK
        int lesson_id FK
        string status "not_started/in_progress/completed"
        int progress "Percentage 0-100"
        datetime last_accessed_at
        datetime completed_at
        datetime created_at
        datetime updated_at
    }
    
    USER_EXERCISE_ATTEMPTS {
        int id PK
        int user_id FK
        int exercise_id FK
        json answers "For multiple choice and essay"
        json images "Array of image URLs for essay"
        decimal score "Score out of total points"
        int total_points
        boolean is_completed
        datetime completed_at
        datetime created_at
        datetime updated_at
    }
    
    NOTIFICATIONS {
        int id PK
        int user_id FK
        string type "progress_update/achievement/reminder"
        string title
        text message
        string channel "email/sms/push"
        boolean is_sent
        datetime sent_at
        datetime scheduled_at
        datetime created_at
    }
    
    CONVERSATION_CONFIGS {
        int id PK
        string name
        text system_prompt "System prompt for OpenAI"
        json response_format "Config for response format"
        json metadata "Additional config options"
        boolean is_default
        datetime created_at
        datetime updated_at
    }
    
    CONVERSATIONS {
        int id PK
        int user_id FK
        int config_id FK "Conversation config"
        string type "essay_review/free_chat"
        string title "Conversation title"
        string status "active/completed/archived"
        json metadata "Additional metadata"
        datetime last_message_at
        datetime created_at
        datetime updated_at
    }
    
    MESSAGES {
        int id PK
        int conversation_id FK
        string role "user/assistant/system"
        text content "Message content"
        json metadata "Additional data (tokens, model, etc.)"
        int order "Message order in conversation"
        datetime created_at
    }
        </div>
        
        <div class="legend">
            <h3>üìã Legend & Notes</h3>
            <div class="legend-item">
                <strong>Core Structure:</strong> GRADES ‚Üí SUBJECTS ‚Üí CHAPTERS ‚Üí SECTIONS ‚Üí LESSONS/EXERCISES
            </div>
            <div class="legend-item">
                <strong>Curriculum:</strong> CURRICULA stores the learning program (ch∆∞∆°ng tr√¨nh h·ªçc) shared across all difficulty levels. Each curriculum is unique per grade, course year, and subject. Contains lessons structure without exercises.
            </div>
            <div class="legend-item">
                <strong>User Flow:</strong> User ƒëƒÉng k√Ω ‚Üí ch·ªçn Grade (l·ªõp) ‚Üí ch·ªçn Subject ‚Üí xem Curriculum/Lessons ‚Üí l√†m Exercises (theo difficulty level)
            </div>
            <div class="legend-item">
                <strong>Progress Tracking:</strong> USER_LESSON_PROGRESS tracks status (not_started/in_progress/completed) and progress percentage for each lesson
            </div>
            <div class="legend-item">
                <strong>Exercise Attempts:</strong> USER_EXERCISE_ATTEMPTS stores all attempts with answers, scores, and completion status
            </div>
            <div class="legend-item">
                <strong>User Levels:</strong> Tracked per subject, calculated based on exercise history and accuracy rate
            </div>
            <div class="legend-item">
                <strong>Exercise Questions:</strong> Supports both multiple choice (JSON options) and essay questions, includes hint field for guidance
            </div>
            <div class="legend-item">
                <strong>Notifications:</strong> Supports email, SMS, and push notifications with scheduling for progress updates and achievements
            </div>
            <div class="legend-item">
                <strong>Authentication:</strong> Users login with username (email is optional, used for notifications only)
            </div>
            <div class="legend-item">
                <strong>Conversations:</strong> Users can have free chat conversations or essay review conversations with AI assistant
            </div>
            <div class="legend-item">
                <strong>Messages:</strong> All messages in conversations are stored for history and context
            </div>
            <div class="legend-item">
                <strong>Conversation Configs:</strong> Configurable response formats and system prompts for different conversation types
            </div>
            <div class="legend-item">
                <strong>Removed Models:</strong> Class, ClassStudent, ClassTeacher, Assignment, Submission (no longer needed for self-paced learning)
            </div>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            er: {
                fontSize: 12,
                layoutDirection: 'TB'
            }
        });
    </script>
</body>
</html>
